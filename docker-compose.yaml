version: '3.8'
services:
  dind:
    image: docker:20.10-dind
    privileged: true
    environment:
      DOCKER_TLS_CERTDIR: ""
    expose:
      - 2375
    logging:
      driver: none
    volumes:
      - ./data:/code
  app:
    build: .
    logging:
      driver: "json-file"
      options:
        max-buffer-size: "4m"
        mode: "non-blocking"
    environment:
      DOCKER_HOST: tcp://dind:2375
      TOKEN: "${TOKEN:-forregistrytoken}"
      TOKEN_ORG: "${TOKEN_ORG:-fororgregistry}"
      ORG: "${ORG:-fororgregistry}"
    depends_on:
      - dind
    volumes:
      - ./data:/code
